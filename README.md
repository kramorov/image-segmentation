# Сегментация изображений
В этом разделе собраны ноутбуки с различными вариантами сетей для сегментации изображений.
Также протестированы различные подходы к подготовке подачи данных в НС.

## PSP net: The Pyramid Scene Parsing Network 
### Общее описания принципа работы PSPnet

### Шаг 1.
Входное изображение передается в базовую НС (фактически - энкодер), на выходе получаем карту признаков (feature map)
### Шаг. 2
####Pyramid pooling module

**Карта признаков (feature map)** передается в **Pyramid pooling module**.
В этом модуле она разделяется на блоки с различным разрешением. 
К каждому блоку применяется свертка.

Например, карта признаков может быть разделена на блоки с уменьшением разрешения в 6,3,2

На этом этапе, мелкие детали изображения захватываются блоками с высоким разрешением,
крупные элементы изображения захватываются блоками с маленьким разрешением.

Что подразумевается под пирамидой: чем выше пирамида (больше делитель разрешения), тем более крупные детали
она может захватывать. Высота пирамиды зависит также от разрешения изображения. 

Чем выше разрешение изображения (больше пикселей),
тем выше должна быть пирамида.

### Шаг 3.
Блоки разворачиваются (**upsampling**) в выходной размер, и конкатенируются между собой и к ним конкатенируется карта признаков из **шага 1**.
### Шаг 4.
**Декодер**.

Применяется еще одна свертка, после которой на выходе получаем сегментированное изображение.

PSP сама по себе не является целиком сегментирующей моделью. Она (как архитектура) скорее является энкодером + pooling.

То есть, половиной решения задачи сегментации. При этом, реализации энкодера для получения feature map могут быть различными.

Вторая половина - декодер, может иметь разные архитектуры.
В практических реализациях PSP чаще всего применяется архитектура билинейного увеличения (**bilinear upsampling**).

В этой реализации есть недостаток: **8x upsmapling decoder** не имеет обучаемых параметров, и поэтому не захватывает мелкие детали изображения.

Поэтому в некоторых реализациях применяется **U-net подобный декодер**, где на разверточные слои пробрасываются связи со сверточных слоев
с аналогичной размерностью.

Такая реализация декодера называется **feature pyramid network (FPN)** и применяется в U-net.

PSP хорошо сегментирует изображения, где целевые предметы могут быть представлены в разном размере
(например, маленькая машина далеко - большая машина близко).

Поэтому PSP предпочтительна для изображений уличных и внутреннх интерьеров, поскольку целевые
предметы на таких изображениях как правило имеют разные размеры.
### Практическая реализация
За основу архитектуры взята сеть из работы HsuanKung Yang https://github.com/hellochick/PSPNet-tensorflow.

Поскольку основная целью написания моего кода было понять принцип построения **PSPnet**, оригинальная архитектура сети **PSPNet50** была немного урезана.
Код переписан под **функциональный API Tensorflow**.

Для обучения сеть использует изображения самолетов и размеченную базу.
Изображения разметки записаны в формате JPEG. Этот формат несколько размывает края разметки, поэтому было необходимо предварительно
обрабатывать изображения разметки для точного разбиения на классы.
Чтобы ускорить обучение НС, файлы с изображениями и разметкой предварительно обрабатывались, весь датасет был сохранен в формате TFRecord.
Из файла TFRecord создается датагенератор, который одновременно подает на вход НС изображение и разметку.

В качестве метрики используется собственная функция метрики, обрабатывающая пересечение двух областей.
